<!DOCTYPE html>
<html>
<head>
    <title>Auto IPFS + Blockchain</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <style>
        body { font-family: Arial; max-width: 800px; margin: 0 auto; padding: 20px; }
        .container { border: 2px dashed #007bff; padding: 30px; border-radius: 10px; margin: 20px 0; }
        button { 
            background: #007bff; color: rgb(118, 70, 70); padding: 15px 30px; 
            border: none; border-radius: 5px; cursor: pointer; font-size: 18px; 
            margin: 10px; 
        }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #results { background: #f8f9fa; padding: 20px; border-radius: 10px; display: none; }
        .hash { font-family: monospace; background: #000; color: #0f0; padding: 10px; word-break: break-all; }
        .step { margin: 15px 0; padding: 10px; border-left: 4px solid #007bff; }
        .debug { background: #fff3cd; padding: 10px; margin: 10px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üöÄ One-Click IPFS + Blockchain Storage</h1>
    
    <div class="debug">
        <h3>üîß Debug Mode Active</h3>
        <div id="debugInfo">Status: Ready</div>
    </div>

    <div class="container">
        <h3>üìÅ Select File & Click Submit</h3>
        <input type="file" id="fileInput">
        <br><br>
        <button onclick="startAutoUpload()" id="submitBtn">üöÄ Submit to IPFS & Blockchain</button>
        
        <div id="progress">
            <div class="step" id="step1">1. Select file</div>
            <div class="step" id="step2">2. Connect wallet (auto)</div>
            <div class="step" id="step3">3. Upload to IPFS</div>
            <div class="step" id="step4">4. Store on blockchain</div>
            <div class="step" id="step5">5. Complete!</div>
        </div>
    </div>

    <div id="results">
        <h3>‚úÖ Success! File stored on decentralized network</h3>
        <div id="resultContent"></div>
    </div>

    <div id="loading" style="display: none; text-align: center;">
        <p>‚è≥ Processing... Please confirm MetaMask transactions</p>
    </div>
<script>
    // Configuration
    const CONTRACT_ADDRESS = "0x7354CD3643264bAe341C73F24454bDA09c383F97";
    const CONTRACT_ABI = [ 
        {
            "inputs": [
                {"internalType": "string", "name": "_ipfsHash", "type": "string"},
                {"internalType": "string", "name": "_fileName", "type": "string"}, 
                {"internalType": "uint256", "name": "_fileSize", "type": "uint256"}
            ],
            "name": "storeHash",
            "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "inputs": [],
            "name": "getFilesCount",
            "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
            "stateMutability": "view",
            "type": "function"
        }
    ];

    const PINATA_JWT = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI2MjQxOWY0Ny1hYTJjLTRjNjgtOWMxMi05ODM5YTZmNWFlNWQiLCJlbWFpbCI6Imt1c2h3YWhhdmFydW45ODhAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInBpbl9wb2xpY3kiOnsicmVnaW9ucyI6W3siZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiRlJBMSJ9LHsiZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiTllDMSJ9XSwidmVyc2lvbiI6MX0sIm1mYV9lbmFibGVkIjpmYWxzZSwic3RhdHVzIjoiQUNUSVZFIn0sImF1dGhlbnRpY2F0aW9uVHlwZSI6InNjb3BlZEtleSIsInNjb3BlZEtleUtleSI6IjViOGMyOWFhMjFjMGRkZjQ3NzFhIiwic2NvcGVkS2V5U2VjcmV0IjoiYWY2ZTVlOGRlZTdiZTliYmI1NzUwMjM2YWQwMGI3M2MyMGE0MTBiOGE3ZmIyODVmMDk4MWJmYjhmY2UwNDlhNSIsImV4cCI6MTc5MDIwMTk1MH0.evw44SeuKEXvFR5K5PTW55MMHUUT5At7rGDjEEuA8JM";

    let web3;
    let accounts;
    let contract;

    // ‚úÖ FIXED: BigInt conversion functions
    function toBigInt(value) {
        return BigInt(value);
    }

    function toNumber(value) {
        return Number(value);
    }

    function toString(value) {
        return String(value);
    }

    // Main function
    async function startAutoUpload() {
        const fileInput = document.getElementById('fileInput');
        if (!fileInput.files[0]) {
            alert('Please select a file first!');
            return;
        }

        try {
            updateStep(1);
            disableSubmit(true);
            showLoading(true);

            // Step 1: Auto-connect wallet
            updateStep(2);
            await connectWallet();
            
            // Step 2: Upload to IPFS
            updateStep(3);
            const ipfsResult = await uploadToIPFS(fileInput.files[0]);
            
            // Step 3: Store on blockchain
            updateStep(4);
            const blockchainResult = await storeOnBlockchain(ipfsResult);
            
            // Step 4: Show results
            updateStep(5);
            showFinalResults(ipfsResult, blockchainResult);
            
        } catch (error) {
            console.error('Auto upload failed:', error);
            alert('Error: ' + error.message);
            resetUI();
        }
    }

    // ‚úÖ FIXED: BigInt-safe connectWallet function
    async function connectWallet() {
        if (typeof window.ethereum === 'undefined') {
            throw new Error('Please install MetaMask!');
        }

        // Request account access
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        web3 = new Web3(window.ethereum);
        
        // Get accounts
        accounts = await web3.eth.getAccounts();
        if (accounts.length === 0) {
            throw new Error('No accounts found in MetaMask');
        }

        // Initialize contract
        contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
        
        // ‚úÖ FIXED: BigInt comparison
        const chainId = await web3.eth.getChainId();
        const sepoliaChainId = toBigInt(11155111); // Convert to BigInt
        
        if (chainId !== sepoliaChainId) {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0xaa36a7' }],
                });
            } catch (error) {
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [{
                        chainId: '0xaa36a7',
                        chainName: 'Sepolia',
                        rpcUrls: ['https://sepolia.infura.io/v3/'],
                        nativeCurrency: { name: 'Sepolia ETH', symbol: 'ETH', decimals: 18 },
                        blockExplorerUrls: ['https://sepolia.etherscan.io']
                    }]
                });
            }
        }
    }

    // Upload to IPFS (same as before)
    async function uploadToIPFS(file) {
        const formData = new FormData();
        formData.append('file', file);

        const metadata = JSON.stringify({ name: file.name });
        formData.append('pinataMetadata', metadata);

        const options = JSON.stringify({ cidVersion: 0 });
        formData.append('pinataOptions', options);

        const response = await fetch('https://api.pinata.cloud/pinning/pinFileToIPFS', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${PINATA_JWT}` },
            body: formData
        });

        if (!response.ok) {
            throw new Error('IPFS upload failed');
        }

        const result = await response.json();
        return {
            hash: result.IpfsHash,
            fileName: file.name,
            fileSize: file.size
        };
    }

    // ‚úÖ FIXED: BigInt-safe blockchain function
    async function storeOnBlockchain(ipfsData) {
        if (!contract || !accounts) {
            throw new Error('Wallet not connected');
        }

        try {
            // Estimate gas
            const gasEstimate = await contract.methods.storeHash(
                ipfsData.hash,
                ipfsData.fileName,
                toBigInt(ipfsData.fileSize) // ‚úÖ Convert to BigInt
            ).estimateGas({ from: accounts[0] });

            // ‚úÖ Convert gas estimate to number and add buffer
            const gasWithBuffer = toNumber(gasEstimate) * 1.2;

            // Send transaction
            const result = await contract.methods.storeHash(
                ipfsData.hash,
                ipfsData.fileName,
                toBigInt(ipfsData.fileSize) // ‚úÖ Convert to BigInt
            ).send({
                from: accounts[0],
                gas: Math.round(gasWithBuffer)
            });

            return result;

        } catch (error) {
            // ‚úÖ Better error handling for BigInt issues
            if (error.message.includes('BigInt')) {
                throw new Error('Blockchain error: Please try again with a smaller file');
            }
            throw error;
        }
    }

    // ‚úÖ FIXED: BigInt-safe results display
    function showFinalResults(ipfsData, blockchainResult) {
        // ‚úÖ Convert BigInt values to string for display
        const blockNumber = toString(blockchainResult.blockNumber);
        const gasUsed = toString(blockchainResult.gasUsed);

        document.getElementById('resultContent').innerHTML = `
            <div class="step">
                <h4>üìÑ File Information</h4>
                <p><strong>Name:</strong> ${ipfsData.fileName}</p>
                <p><strong>Size:</strong> ${(ipfsData.fileSize / 1024).toFixed(2)} KB</p>
            </div>
            
            <div class="step">
                <h4>üåê IPFS Details</h4>
                <p><strong>IPFS Hash (CID):</strong></p>
                <div class="hash">${ipfsData.hash}</div>
                <p><a href="https://gateway.pinata.cloud/ipfs/${ipfsData.hash}" target="_blank">üîó View on IPFS Gateway</a></p>
            </div>
            
            <div class="step">
                <h4>‚õìÔ∏è Blockchain Details</h4>
                <p><strong>Transaction Hash:</strong></p>
                <div class="hash">${blockchainResult.transactionHash}</div>
                <p><strong>Block Number:</strong> ${blockNumber}</p>
                <p><strong>Gas Used:</strong> ${gasUsed}</p>
                <p><a href="https://sepolia.etherscan.io/tx/${blockchainResult.transactionHash}" target="_blank">üîç View on Etherscan</a></p>
            </div>
        `;
        
        document.getElementById('results').style.display = 'block';
        showLoading(false);
    }

    // UI Helper functions (same as before)
    function updateStep(stepNumber) {
        for (let i = 1; i <= 5; i++) {
            const stepElement = document.getElementById('step' + i);
            stepElement.style.color = '#666';
            stepElement.style.fontWeight = 'normal';
        }
        
        const currentStep = document.getElementById('step' + stepNumber);
        if (currentStep) {
            currentStep.style.color = '#007bff';
            currentStep.style.fontWeight = 'bold';
        }
    }

    function disableSubmit(disabled) {
        document.getElementById('submitBtn').disabled = disabled;
        document.getElementById('submitBtn').textContent = disabled ? 
            '‚è≥ Processing...' : 'üöÄ Submit to IPFS & Blockchain';
    }

    function showLoading(show) {
        document.getElementById('loading').style.display = show ? 'block' : 'none';
    }

    function resetUI() {
        disableSubmit(false);
        showLoading(false);
        updateStep(1);
    }

    // Initialize
    window.addEventListener('load', () => {
        updateStep(1);
    });
</script>
</body>
</html>